plugins {
    id "com.android.application" apply false
    id "org.jetbrains.kotlin.android" apply false
    id "dev.flutter.flutter-gradle-plugin" apply false
}

rootProject.buildDir = "../build"

apply from: "${rootDir}/versions.gradle"

subprojects {
    project.buildDir = "${rootProject.buildDir}/${project.name}"
    project.evaluationDependsOn(":app")
}

// ============================================================
// ðŸ”§ GLOBAL ENFORCED ANDROID CONFIG (NO afterEvaluate)
// ============================================================
subprojects { sub ->
    def androidExt = sub.extensions.findByType(
        com.android.build.gradle.BaseExtension
    )

    if (androidExt != null) {
        println("ðŸ”§ Applying SDK versions to ${sub.name}")

        androidExt.compileSdkVersion compileSdkVersion

        androidExt.defaultConfig {
            minSdk minSdkVersion
            targetSdk targetSdkVersion
        }
    }
}

// ============================================================
// ðŸ”§ Force legacy NDK for integration_test + path_provider
//    (SAFE block â€” runs after all projects are fully loaded)
// ============================================================
gradle.projectsEvaluated {

    subprojects { sub ->

        if (sub.name.contains("integration_test") ||
            sub.name.contains("path_provider_android")) {

            println("âš  Overriding NDK to legacy ${ndkLegacy} for ${sub.name}")

            def androidExt = sub.extensions.findByType(
                com.android.build.gradle.BaseExtension
            )

            if (androidExt != null) {
                androidExt.ndkVersion ndkLegacy
            }
        }
    }
}

// Clean task
tasks.register("clean", Delete) {
    delete rootProject.buildDir
}
