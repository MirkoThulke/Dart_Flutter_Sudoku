# ------------------------------------------------------------
# Build image:
#   docker build -t jenkins_sudoku_image:latest .
#   docker build --no-cache -t jenkins_sudoku_image:latest .
# ------------------------------------------------------------


# ------------------------------------------------------------
# Install minimal dependencies + Docker CLI
# ------------------------------------------------------------
# Base image
FROM jenkins/jenkins:lts

# Switch to root to install packages
USER root

# Install minimal dependencies + Docker CLI + Git
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        docker-cli \
        ca-certificates \
        curl \
        git \
        tini \
    && rm -rf /var/lib/apt/lists/*

# Allow Jenkins to access docker socket
RUN groupadd -f docker && usermod -aG docker jenkins

# Ensure docker is discoverable
ENV PATH="/usr/bin:/usr/local/bin:$PATH"

# Disable setup wizard in Jenkins
ENV JAVA_OPTS="-Djenkins.install.runSetupWizard=false"

# ENTRYPOINT / CMD
ENTRYPOINT ["/usr/bin/tini", "--"]
CMD ["/usr/local/bin/jenkins.sh"]

# Switch to Jenkins user
USER jenkins


# Install required Jenkins plugins
RUN jenkins-plugin-cli --plugins \
    git \
    workflow-aggregator \
    github \
    github-branch-source \
    pipeline-stage-view